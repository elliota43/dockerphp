#!/bin/sh
set -eu

# Load .env and .env.<APP_ENV> into script (won't overwrite OS env vars.)
#set -a
#    env_overwrite=./.env.${APP_ENV-dev}
#    declare -px >> /tmp/envsrc && . ./.env && if [ -f ${env_overwrite} ]; then . $env_overwrite; fi && . /tmp/envsrc \
#     && rm /tmp/envsrc && unset env_overwrite
#set +a

# ----------------------------------------------------------------------------------------------------------------------

LOCK=/var/lock/runtime-setup.lock
if [ ! -f ${LOCK} ]; then
    # !-- We want to only print in logs if something wrong happends, hence how below code is written. --!

    # Run custom ad-hoc post-deployment script
    error=`docker-post-deployment 2>&1`  \
    || if [ $? -ne 0 ]; then printf "%s \nerror running post-deployment script (exit code: $?)" "$error"; exit 1; fi

    # Permissions for var directory (generated by post-install-cmd)
    chown -R www-data:www-data var

    touch ${LOCK}
fi

# ----------------------------------------------------------------------------------------------------------------------